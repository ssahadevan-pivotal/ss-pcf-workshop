= Lab 3 - Scaling Applications

[abstract]
--
Cloud Foundry makes the work of horizontally scaling application instances and updating load balancer routing tables easy.

In this lab, we'll use the _Attendees_ application app to illustrate Cloud Foundry operations such as scaling.
--

== A Bit of Review

Your instance of the _Attendees_ app should still be running from the end of link:../lab_02/lab_02.adoc[Lab 2].
Visit the application in your browser by hitting the route that was generated by the CLI:

image::/../../common/images/Attendees_Index.png[]

The information dialog in the top right-hand corner indicates that we are seeing the first instance of the application running (0 Index)

== Before we scale

Since the application we deployed in ../lab_02/lab_02.adoc[Lab 2] uses the free version of ClearDB, which allows limited connections, let's roll back to the in-memory DB by un-binding and restaging before scaling.

----
$ cf unbind-service attendees attendees-db
$ cf restage attendees
----

== Scale the Application Up

. Now let's increase the number of running application instances to 3:
+
----
$ cf scale -i 3 attendees
Scaling app attendees in org STLWorkshop / space instructor as dj.kaiping@perficient.com...
OK

----
+
In reporting `OK`, the CLI is letting you know that the additional requested instances have been started, but they are not yet necessarily running.

. We can determine how many instances are actually running like this:
+
====
----
$ cf app attendees
Showing health and status for app attendees in org STLWorkshop / space instructor as dj.kaiping@perficient.com...

name:              attendees
requested state:   started
instances:         3/3
usage:             1G x 3 instances
routes:            attendees-reflective-dog.cfapps.io
last uploaded:     Sun 01 Apr 17:14:44 CDT 2018
stack:             cflinuxfs2
buildpack:         client-certificate-mapper=1.5.0_RELEASE container-security-provider=1.13.0_RELEASE java-buildpack=v4.9-offline-https://github.com/cloudfoundry/java-buildpack.git#830f4c3 java-main java-opts java-security jvmkill-agent=1.12.0_RELEASE open-jdk-l...

     state      since                  cpu    memory         disk           details
#0   running<1>    2018-04-01T23:03:52Z   0.2%   457.4M of 1G   160.8M of 1G
#1   starting<2>   2018-04-01T23:05:59Z   0.2%   435.4M of 1G   160.8M of 1G
#2   starting   2018-04-01T23:05:59Z   0.0%   40K of 1G      8K of 1G

----
<1> This application instance has completed the startup process and is actually able to accept requests.
<2> This application instance is still starting and will not have any requests routed to it.
====

. Eventually all instances will converge to a running state:
+
----
$ cf app attendees
Showing health and status for app attendees in org STLWorkshop / space instructor as dj.kaiping@perficient.com...

name:              attendees
requested state:   started
instances:         3/3
usage:             1G x 3 instances
routes:            attendees-reflective-dog.cfapps.io
last uploaded:     Sun 01 Apr 17:14:44 CDT 2018
stack:             cflinuxfs2
buildpack:         client-certificate-mapper=1.5.0_RELEASE container-security-provider=1.13.0_RELEASE java-buildpack=v4.9-offline-https://github.com/cloudfoundry/java-buildpack.git#830f4c3 java-main java-opts java-security jvmkill-agent=1.12.0_RELEASE open-jdk-l...

     state     since                  cpu    memory         disk           details
#0   running   2018-04-01T23:03:52Z   0.2%   457.4M of 1G   160.8M of 1G
#1   running   2018-04-01T23:06:18Z   0.2%   416.7M of 1G   160.8M of 1G
#2   running   2018-04-01T23:06:22Z   0.2%   431.4M of 1G   160.8M of 1G
----

. Revisit the application route in the browser.
Refresh several times.
You should observe the instance index changing as you do so:

image::/../../common/images/Attendees_Scaled.png[]

The aforementioned http://docs.cloudfoundry.org/concepts/architecture/router.html[(Go)Router] is applying a random routing algorithm to all of the application instances assigned to this route.
As an instance reaches the `running` state, its http://docs.cloudfoundry.org/concepts/architecture/execution-agent.html[DEA] registers that instance in the routing table assigned to its route by sending a message to Cloud Foundry's message bus.
All (Go)Router instances are subscribed to this channel and register the routes independently.
This makes for very dynamic and rapid reconfiguration!

== Scale the Application Down

. We can scale the application instances back down as easily as we scaled them up, using the same command structure:
+
----
$ cf scale -i 1 attendees
Scaling app attendees in org STLWorkshop / space instructor as dj.kaiping@perficient.com...
OK
----

. Check the application status again:
+
----
$ cf app attendees
Showing health and status for app attendees in org STLWorkshop / space instructor as dj.kaiping@perficient.com...

name:              attendees
requested state:   started
instances:         1/1
usage:             1G x 1 instances
routes:            attendees-reflective-dog.cfapps.io
last uploaded:     Sun 01 Apr 17:14:44 CDT 2018
stack:             cflinuxfs2
buildpack:         client-certificate-mapper=1.5.0_RELEASE container-security-provider=1.13.0_RELEASE java-buildpack=v4.9-offline-https://github.com/cloudfoundry/java-buildpack.git#830f4c3 java-main java-opts java-security jvmkill-agent=1.12.0_RELEASE open-jdk-l...

     state     since                  cpu    memory         disk           details
#0   running   2018-04-01T23:03:52Z   0.2%   457.4M of 1G   160.8M of 1G
----
+
As you can see, we're back down to only one instance running, and it is in fact the original index 0 that we started with.

. Confirm that by again revisiting the route in the browser and checking the instance index and request counter:

image::/../../common/images/Attendees.png[]

link:/README.md#course-materials[Course Materials home] | link:/session_05/lab_04/lab_04.adoc[Lab 4 - Spring Boot Actuator Lab]
